<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Processing Video - YouTube Slide Extractor</title>
    <link href="https://cdn.replit.com/agent/bootstrap-agent-dark-theme.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="text-center mb-4">
                    <h1 class="display-5 mb-3">
                        <i class="fab fa-youtube text-danger me-3"></i>
                        Processing Video
                    </h1>
                    <p class="lead">Please wait while we extract slides from your video...</p>
                </div>

                <!-- Processing Status Card -->
                <div class="card shadow-lg">
                    <div class="card-body p-5">
                        <!-- Progress Section -->
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="fw-bold" id="statusText">Initializing...</span>
                                <span class="badge bg-primary" id="progressPercent">0%</span>
                            </div>
                            <div class="progress" style="height: 20px;">
                                <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                     role="progressbar" 
                                     id="progressBar" 
                                     style="width: 0%">
                                </div>
                            </div>
                        </div>

                        <!-- Status Message -->
                        <div class="alert alert-info" id="statusMessage">
                            <i class="fas fa-info-circle me-2"></i>
                            <span id="messageText">Starting video processing...</span>
                        </div>

                        <!-- Loading Animation -->
                        <div class="text-center py-4" id="loadingSection">
                            <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <div class="mt-3">
                                <p class="text-muted">This may take a few minutes depending on the video length...</p>
                            </div>
                        </div>

                        <!-- Success Section (hidden initially) -->
                        <div class="text-center py-4 d-none" id="successSection">
                            <i class="fas fa-check-circle text-success" style="font-size: 4rem;"></i>
                            <h3 class="mt-3 text-success">Processing Complete!</h3>
                            <p class="text-muted mb-4">Your PDF has been generated successfully.</p>
                            <a href="#" class="btn btn-success btn-lg" id="downloadBtn">
                                <i class="fas fa-download me-2"></i>
                                Download PDF
                            </a>
                        </div>

                        <!-- Error Section (hidden initially) -->
                        <div class="text-center py-4 d-none" id="errorSection">
                            <i class="fas fa-exclamation-triangle text-danger" style="font-size: 4rem;"></i>
                            <h3 class="mt-3 text-danger">Processing Failed</h3>
                            <p class="text-muted mb-4" id="errorText">An error occurred while processing your video.</p>
                            <a href="{{ url_for('index') }}" class="btn btn-primary">
                                <i class="fas fa-arrow-left me-2"></i>
                                Try Again
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Processing Steps -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-list-ol me-2"></i>Processing Steps
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 text-center mb-3">
                                <div class="processing-step" id="step1">
                                    <i class="fas fa-download fa-2x mb-2"></i>
                                    <h6>Download</h6>
                                    <small class="text-muted">Downloading video</small>
                                </div>
                            </div>
                            <div class="col-md-3 text-center mb-3">
                                <div class="processing-step" id="step2">
                                    <i class="fas fa-film fa-2x mb-2"></i>
                                    <h6>Extract</h6>
                                    <small class="text-muted">Extracting frames</small>
                                </div>
                            </div>
                            <div class="col-md-3 text-center mb-3">
                                <div class="processing-step" id="step3">
                                    <i class="fas fa-search fa-2x mb-2"></i>
                                    <h6>Analyze</h6>
                                    <small class="text-muted">Detecting slides</small>
                                </div>
                            </div>
                            <div class="col-md-3 text-center mb-3">
                                <div class="processing-step" id="step4">
                                    <i class="fas fa-file-pdf fa-2x mb-2"></i>
                                    <h6>Generate</h6>
                                    <small class="text-muted">Creating PDF</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const processingId = "{{ processing_id }}";
        
        function updateProgress() {
            fetch(`/status/${processingId}`)
                .then(response => response.json())
                .then(data => {
                    const progressBar = document.getElementById('progressBar');
                    const progressPercent = document.getElementById('progressPercent');
                    const statusText = document.getElementById('statusText');
                    const messageText = document.getElementById('messageText');
                    const statusMessage = document.getElementById('statusMessage');
                    
                    // Update progress
                    progressBar.style.width = data.progress + '%';
                    progressPercent.textContent = data.progress + '%';
                    statusText.textContent = data.message || 'Processing...';
                    messageText.textContent = data.message || 'Processing...';
                    
                    // Update step indicators
                    updateStepIndicators(data.status);
                    
                    if (data.status === 'completed') {
                        // Show success section
                        document.getElementById('loadingSection').classList.add('d-none');
                        document.getElementById('successSection').classList.remove('d-none');
                        
                        // Set download link
                        const downloadBtn = document.getElementById('downloadBtn');
                        downloadBtn.href = `/download/${processingId}`;
                        
                        // Update status message
                        statusMessage.className = 'alert alert-success';
                        statusMessage.innerHTML = '<i class="fas fa-check-circle me-2"></i><span id="messageText">' + data.message + '</span>';
                        
                    } else if (data.status === 'error') {
                        // Show error section
                        document.getElementById('loadingSection').classList.add('d-none');
                        document.getElementById('errorSection').classList.remove('d-none');
                        
                        // Update error message
                        document.getElementById('errorText').textContent = data.error || 'An unknown error occurred.';
                        statusMessage.className = 'alert alert-danger';
                        statusMessage.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i><span id="messageText">' + (data.error || 'Processing failed') + '</span>';
                        
                    } else {
                        // Continue polling
                        setTimeout(updateProgress, 2000);
                    }
                })
                .catch(error => {
                    console.error('Error fetching status:', error);
                    setTimeout(updateProgress, 5000); // Retry after longer delay
                });
        }
        
        function updateStepIndicators(status) {
            const steps = ['step1', 'step2', 'step3', 'step4'];
            const statusMap = {
                'downloading': 0,
                'extracting': 1,
                'analyzing': 2,
                'generating': 3,
                'completed': 4
            };
            
            const currentStep = statusMap[status] || 0;
            
            steps.forEach((stepId, index) => {
                const step = document.getElementById(stepId);
                if (index < currentStep) {
                    step.classList.add('completed');
                    step.classList.remove('active');
                } else if (index === currentStep) {
                    step.classList.add('active');
                    step.classList.remove('completed');
                } else {
                    step.classList.remove('active', 'completed');
                }
            });
        }
        
        // Start polling for status updates
        updateProgress();
    </script>
</body>
</html>
